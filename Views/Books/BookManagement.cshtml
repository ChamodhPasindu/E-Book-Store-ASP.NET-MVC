@model IEnumerable<EBookStore.Models.Book>

@{
    ViewData["Title"] = "Admin Book Management";
}

<div class="container mt-5">
    <h2>Book Management</h2>

    <!-- Add/Edit Book Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 id="formTitle">Add New Book</h5>
        </div>
        <div class="card-body">
            <form asp-action="AddOrEdit" method="post" enctype="multipart/form-data" id="bookForm">
                @Html.AntiForgeryToken()

                <input type="hidden" id="bookId" name="BookID" value="0" />

                <div class="form-group">
                    <label for="Title">Title</label>
                    <input type="text" name="Title" class="form-control" id="Title" required />
                </div>

                <div class="form-group">
                    <label for="Author">Author</label>
                    <input type="text" name="Author" class="form-control" id="Author" required />
                </div>

                <div class="form-group">
                    <label for="Category">Category</label>
                    <input type="text" name="Category" class="form-control" id="Category" required />
                </div>

                <div class="form-group">
                    <label for="Price">Price</label>
                    <input type="number" name="Price" class="form-control" id="Price" step="0.01" required />
                </div>

                <div class="form-group">
                    <label for="QuantityInStock">Quantity</label>
                    <input type="number" name="QuantityInStock" class="form-control" id="QuantityInStock" required />
                </div>

                <div class="form-group">
                    <label for="PublicationDate">Publication Date</label>
                    <input type="date" name="PublicationDate" class="form-control" id="PublicationDate" required />
                </div>

                <div class="form-group">
                    <label for="ImageFile">Book Image</label>
                    <input type="file" name="ImageFile" class="form-control" id="ImageFile" />
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">Add Book</button>
            </form>
        </div>
    </div>

    <!-- Book Table -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Author</th>
                <th>Category</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var book in Model)
            {
                <tr>
                    <td>@book.Title</td>
                    <td>@book.Author</td>
                    <td>@book.Category</td>
                    <td>@book.Price</td>
                    <td>@book.QuantityInStock</td>
                    <td>
                        <button class="btn btn-warning" onclick="editBook(@book.BookID)">Edit</button>
                        <button class="btn btn-info" data-toggle="modal" data-target="#viewBookModal" onclick="viewBook(@book.BookID)">View</button>
                        <button class="btn btn-danger" data-toggle="modal" data-target="#deleteConfirmationModal" data-book-id="@book.BookID" onclick="deleteConfirm(@book.BookID)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- View Book Modal -->
<div class="modal fade" id="viewBookModal" tabindex="-1" role="dialog" aria-labelledby="viewBookModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewBookModalLabel">Book Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#viewBookModal').modal('hide')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong>Title:</strong> <span id="viewTitle"></span></p>
                <p><strong>Author:</strong> <span id="viewAuthor"></span></p>
                <p><strong>Category:</strong> <span id="viewCategory"></span></p>
                <p><strong>Price:</strong> <span id="viewPrice"></span></p>
                <p><strong>Quantity:</strong> <span id="viewQuantity"></span></p>
                <p><strong>Publication Date:</strong> <span id="viewPublicationDate"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="$('#viewBookModal').modal('hide')">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="$('#deleteConfirmationModal').modal('hide')">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this book?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="$('#deleteConfirmationModal').modal('hide')">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function editBook(bookId) {
            $.get('@Url.Action("GetBook")', { id: bookId }, function (data) {
                $('#bookId').val(data.bookID);
                $('#Title').val(data.title);
                $('#Author').val(data.author);
                $('#Category').val(data.category);
                $('#Price').val(data.price);
                $('#QuantityInStock').val(data.quantityInStock);
                $('#PublicationDate').val(data.publicationDate.split('T')[0]);

                $('#formTitle').text('Edit Book');
                $('#submitBtn').text('Update Book');
            });
        }

        function viewBook(bookId) {
            $.get('@Url.Action("GetBook")', { id: bookId }, function (data) {
                console.log(data);

                $('#viewTitle').text(data.title);
                $('#viewAuthor').text(data.author);
                $('#viewCategory').text(data.category);
                $('#viewPrice').text(data.price);
                $('#viewQuantity').text(data.quantityInStock);
                $('#viewPublicationDate').text(data.publicationDate.split('T')[0]);

                // Open the modal after setting data
                $('#viewBookModal').modal('show');
            });
        }

        function deleteConfirm(bookId) {
            $('#confirmDeleteBtn').data('book-id', bookId);
            $('#deleteConfirmationModal').modal('show');
        }

        $('#confirmDeleteBtn').on('click', function () {
            var bookId = $(this).data('book-id'); 

            $.ajax({
                url: '@Url.Action("Delete")',
                type: 'POST',
                data: { id: bookId },
                success: function (response) {
                    location.reload(); 
                },
                error: function (err) {
                    console.error('Error deleting book:', err);
                }
            });
        });
    </script>
}
